<?xml version="1.0"?>
<project name="XmlTask" default="main" basedir="." xmlns:ivy="antlib:org.apache.ivy.ant">
  <property name="java.baseline" value="1.6"/>
  <property name="src.dir" value="src/main/java"/>
  <property name="src.test.dir" value="src/test/java"/>
  <property name="build.dir" value="build"/>
  <property name="classes.dir" value="${build.dir}/classes"/>
  <property name="javadoc.dir" value="${build.dir}/javadoc"/>
  <property name="tests.dir" value="${build.dir}/tests"/>

  <!-- Ivy: NB! 2.5+ requires Java 7 baseline -->
  <property name="ivy.version" value="2.5.0"/>
  <property name="ivy.dir" value="${user.home}/.ivy2/cache/org.apache.ivy/jars"/>
  <property name="ivy.jar.name" value="ivy-${ivy.version}.jar"/>
  <property name="ivy.jar.name" value="ivy-${ivy.version}.jar"/>
  <available property="has.ivy" file="${ivy.dir}/${ivy.jar.name}" type="file"/>

  <target name="get-ivy" unless="has.ivy">
    <mkdir dir="${ivy.dir}"/>
    <get usetimestamp="true" src="https://repo1.maven.org/maven2/org/apache/ivy/ivy/${ivy.version}/${ivy.jar.name}"
         skipexisting="true"
         dest="${ivy.dir}/${ivy.jar.name}"/>
  </target>

  <target name="init-ivy" depends="get-ivy">
    <taskdef resource="org/apache/ivy/ant/antlib.xml" uri="antlib:org.apache.ivy.ant" classpath="${ivy.dir}/${ivy.jar.name}"/>
    <ivy:settings file="${basedir}/ivy.settings.xml"/>
  </target>

  <target name="resolve" depends="init-ivy">
    <ivy:resolve file="ivy.xml"/>
    <ivy:cachepath pathid="compile.classpath" conf="compile" type="jar"/>
    <ivy:cachepath pathid="test.classpath" conf="test" type="jar"/>
    <!-- prepare dirs -->
    <mkdir dir="${classes.dir}"/>
    <echo file="${classes.dir}/xmltask.properties" message="com.oopsconsultancy.xmltask.version = ${ivy.version}"/>
  </target>

  <target name="javac" depends="resolve" description="Java source build">
    <javac srcdir="${src.dir}" destdir="${classes.dir}" debug="on" nowarn="true"
           includeantruntime="false" source="${java.baseline}" target="${java.baseline}"
           classpathref="compile.classpath">
      <include name="**/*.java"/>
    </javac>
  </target>

  <target name="jar" depends="javac">
    <jar jarfile="${build.dir}/${ivy.module}-${ivy.revision}.jar" basedir="${classes.dir}"
         includes="com/oopsconsultancy/**/*.class,xmltask.properties"
         excludes="**/test/**/*"/>
  </target>

  <target name="init-test" depends="javac" description="Java test source build">
    <javac srcdir="${src.test.dir}" destdir="${classes.dir}" debug="on" nowarn="true"
           includeantruntime="false" source="${java.baseline}" target="${java.baseline}">
      <include name="**/*.java"/>
      <classpath>
        <pathelement location="${classes.dir}"/>
        <path refid="test.classpath"/>
      </classpath>
    </javac>
    <copy todir="${tests.dir}">
      <fileset dir="src/test/resources" includes="current/**" excludes="**/*.pl"/>
    </copy>
  </target>

  <target name="test" depends="init-test">
    <junit haltonfailure="true" dir="${tests.dir}" tempdir="${tests.dir}">
      <batchtest fork="yes" todir="${build.dir}">
        <fileset dir="${src.test.dir}">
          <include name="**/*Test*.java"/>
        </fileset>
      </batchtest>
      <classpath>
        <pathelement path="${classes.dir}"/>
        <path refid="test.classpath"/>
      </classpath>
      <formatter type="plain" usefile="no"/>
      <formatter type="xml"/>
      <sysproperty key="project.test.workingDirectory" value="."/>
    </junit>
  </target>

  <target name="main" depends="test,javadoc" description="Complete build/test"/>

  <target name="javadoc" depends="resolve" description="Javadoc build">
    <!-- A workaround for a "unnamed module" error -->
    <condition property="ant.build.javac.source" value="1.8" else="${java.baseline}">
      <javaversion atleast="9"/>
    </condition>
    <javadoc destdir="${javadoc.dir}" author="true" version="true" use="true" windowtitle="Ant xmltask ${ivy.revision}">
      <packageset dir="${src.dir}" defaultexcludes="yes">
        <include name="com/oopsconsultancy/**"/>
      </packageset>
      <doctitle><![CDATA[<h1>Ant xmltask ${ivy.revision}</h1>]]></doctitle>
      <bottom><![CDATA[<i>Ant xmltask ${ivy.revision}</i>]]></bottom>
      <link href="https://docs.oracle.com/javase/6/docs/api/"/>
    </javadoc>
  </target>

  <target name="package" depends="jar,javadoc" description="Creates the appropriate archives">
    <jar destfile="${build.dir}/${ivy.module}-${ivy.revision}-javadoc.jar" basedir="${javadoc.dir}"/>
    <jar jarfile="${build.dir}/${ivy.module}-${ivy.revision}-sources.jar">
      <fileset dir="${src.dir}" includes="**/*.java"/>
    </jar>
    <tar tarfile="${build.dir}/${ivy.module}-${ivy.revision}.tar.gz" compression="gzip">
      <tarfileset dir="." includes="LICENSE,CREDITS,CHANGES,*.xml"/>
      <tarfileset dir="${classes.dir}" includes="xmltask.properties"/>
      <tarfileset dir="src/site" prefix="doc" includes="*.html,*.css,*.gif,*.jpg"/>
    </tar>
    <echo>Created source and documentation archives</echo>
  </target>

  <target name="clean" description="Clean build tree">
    <delete dir="${build.dir}"/>
    <delete includeemptydirs="true">
      <fileset dir="src/test/resources" includes="**/scripts/*-out.xml"/>
      <fileset dir="src/test/resources" includes="**/scripts/to/**"/>
      <fileset dir="src/test/resources" includes="**/scripts/from/**"/>
    </delete>
  </target>
</project>
